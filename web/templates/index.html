<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Bitunix Bot Control</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <h1>Bitunix GRID Trading Bot</h1>

  <p>Status:
    <strong class="{{ 'green' if running else 'red' }}">
      {{ "l√§uft mit Config " + config if running else "gestoppt" }}
    </strong>
  </p>

  <div class="controls">
    {% if not running %}
      <form method="post" class="form-inline">
        <label>Config ausw√§hlen:</label>
        <select name="config" required>
          <option value="" disabled selected>-- Bitte w√§hlen --</option>
          {% for cfg in configs %}
            <option value="{{ cfg }}">{{ cfg }}</option>
          {% endfor %}
        </select>
        <button type="submit">Starten</button>
      </form>
    {% else %}
      <a href="{{ url_for('stop') }}"><button>Stop</button></a>
    {% endif %}

    <div class="log-actions" aria-label="Log-Steuerung">
      <button type="button" onclick="toTop()">Zum Anfang</button>
      <button type="button" onclick="toBottom()">Zum Ende</button>
      <button type="button" onclick="location.reload()">Aktualisieren</button>
    </div>
  </div>

  <pre id="logbox">{{ "\n".join(logs) }}</pre>

  <script>
    // Scroll-Steuerung & Zustand
    const box = document.getElementById('logbox');

    function toTop(){ box.scrollTop = 0; }
    function toBottom(){ box.scrollTop = box.scrollHeight; }

    function atBottom(el){
      return el.scrollHeight - el.scrollTop - el.clientHeight < 10;
    }

    // --- üîÅ Automatisches Log-Update ---
    async function updateLogs(){
      try {
        const res = await fetch("/logs");
        const data = await res.json();
        const stick = atBottom(box);
        box.textContent = data.logs.join("\n");
        if (stick) toBottom();
      } catch(e) {
        console.error("‚ö†Ô∏è Log-Update fehlgeschlagen:", e);
      }
    }

    // alle 60 Sekunden aktualisieren (60000 ms)
    setInterval(updateLogs, 10000);

    // --- üß≠ Scroll-Zustand merken & wiederherstellen ---
    window.addEventListener('load', () => {
      const stick = sessionStorage.getItem('stickBottom') === '1';
      const saved = parseInt(sessionStorage.getItem('logScroll') || '0', 10);
      if (stick) toBottom();
      else if (!isNaN(saved)) box.scrollTop = saved;
    });

    box.addEventListener('scroll', () => {
      sessionStorage.setItem('logScroll', box.scrollTop);
      sessionStorage.setItem('stickBottom', atBottom(box) ? '1' : '0');
    });
  </script>
</body>
</html>
